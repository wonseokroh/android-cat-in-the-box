# ( ⓛ ω ⓛ \*) meooooooow

오늘할일 ( 8 월 14 일 화요일)

1. 고양이 고르는 창 만들기
2. 서버와 연결해서 테스트해보기
3. react-navigation 공부

오늘의 마무리

1. 위쪽에 구역 정보같은게 나오면 좋겠으나 구현가능할지는 모름. <Cat/> 컴포넌트를 따로 만들어서 안에서 부모 컴포넌트로 고양이 아이디를 올리는데 처음에 안들어가서 헤맸음. Cat 에서 state 에 담은 후에 넘기면 들어갔음.
2. 서버와 연결해서 테스트는 못했음.
3. 딴거 하느라 아직 못봤음.

# ( ⓛ ω ⓛ \*) meooooooow

오늘할일 ( 8 월 16 일 목요일)

1. 타이머 마무리
2. 클라이언트 모두 merge 하기
3. 시작시 socket.io jwt 로 토큰 확인하기

오늘의 마무리

1. 타이머를 setTimeout 으로 돌리면 오차가 많이 생겨서 컴포넌트를 두개로 나눠서 receiveProps 를 사용해서 구현했다. 오차를 잡음.

2. 유저 정보 받아오기

a. 처음에 앱을 시동했을 때 서버에서 유저정보를 받아와서 로컬 스토리지에 저장하려했으나, 이경우에는 채팅을 한 뒤에는 새로운 정보가 업데이트되지 않는다.
b. 그렇다면 채팅이 끝난 뒤에도 서버에서 유저 정보를 보내주면 업데이트된 정보를 얻을 수 있다. 하지만 이 경우에는 두번이나 요청을 보내야하기 때문에 효율적이지 못하다.
c. 따라서 유저정보가 필요한 순간, 프로필을 열람하는 순간에만 post 요청을 보내서 유저정보를 받는 것이 가장 최신 정보를 효율적으로 받을 수 있는 방법이라는 결론에 다다름.

3. 소켓을 여는 시점

a. 앱을 처음 구동했을때 첫페이지에서 소켓을 열어서 토큰을 보내는 방식이었다.
b. 그러나 고양이 선택 페이지에서는 소켓이 열리지 않음 그리고 첫번째부터 오픈 박스 페이지까지 소켓을 이동시켜야하는데 props 로 넘기는게 번거로움
c. 소켓이 필요한 순간은 채팅방이 열리는 순간이므로 오픈 박스 페이지에서 소켓을 열어 토큰과 위치정보를 보내고 채팅방 입장까지 전달하는 편이 가장 효율적인 것 같다.
d. 나머지 자잘한 정보들은 http 리퀘스트로 요청하는 편이 낫다. 계속 연결되어 있을 필요가 없음.
e. 그런데 context API 라는게 있다는걸 알게됨. 이걸 쓰면 전역으로 소켓을 빼놓을 수 있을 듯.

# ( ⓛ ω ⓛ \*) meooooooow

오늘할일 ( 8 월 17 일 금요일)

1. context API
2. 소켓연결
3. token 받아오기

오늘의 마무리

채팅방에 입장하는 부분에서만 소켓을 연결하려했으나 뒷단에서 쓰는 토큰이 소켓 전용 토큰이라 소켓으로 정보를 주고 받아야만 됨. 그래서 소켓을 전역에서 가져다 쓸 수 있는 방법을 찾다보니 리액트 16.3 부터는 context api 가 쓸만해져서 리덕스를 대체할 수 있다는 소릴 듣고 사용하기로 했음.

context api 도 <Store.Consumer>를 랜더 함수 밖에서 사용할 수 없어서 소켓을 불러올 수가 없었음. 그래서 최상단 컴포넌트에서 소켓을 연결한뒤 소켓을 스토어로 넘겨서 사용하려는 컴포넌트에서 소켓을 받아 외부함수의 인자로 넣어서 소켓 이벤트를 날리는 방법을 사용.

근데 또 문제가 생긴게 <Store.Consumer>를 사용할 수 없는 컴포넌트, 즉 액션이 하나도 없는 컴포넌트는 외부함수의 인자로 쓸 소켓을 받아올 수 가 없었다. 이건 아직 해결을 못함? 했나?

또 문제는 최상단 컴포넌트의 constructor 에서 소켓을 연결하는데 그 연결하는 시점에 토큰을 불러올 수가 없었다. asyncStorage 는 아이템을 불러오는데 시간이 걸리기 때문에 비동기 처리를 해야하는데 컨스트럭터 안에서는 비동기 처리가 불가능했다. 따라서 존나 삽질을 하다하다하다 안되서 최상단 컴포넌트인 App.js 와 appPresenter.js 를 하나 더 만들어서 app.js 에서 토큰을 가져와 props 로 appPresenter 로 넘겨줬다.

문제는 여기서 생겼다. componentDidMount 로 토큰을 받아서 setState 로 토큰을 담아 넘겨야하는데 밑에서 바뀐 스테이트가 넘어가질 않았다. 찾아보니 랜더될때 토큰이 박히지 않은 스테이트가 프롭으로 넘어가고 did mount 되면서 setState 로 토큰이 스테이트 박힌다. 스테이트가 바뀌니 재랜더가 되고 바뀐 스테이트가 다시 프롭으로 넘어가야 할 것 같은데 넘어가질 않는다. 그래서 스테이트가 바뀔때까지 기다렸다가 삼항연산자로 바뀐 뒤 스테이트를 프롭으로 넘겨줬다.
대체 이게 왜 안되는지 아직도 모르겠다.

시발

# ( ⓛ ω ⓛ \*) meooooooow

오늘의할일 (8 월 20 일 월요일)

1. 소켓관련 리펙토링
2. 남은 시간을 서버에서 받아오고 카운트하기

오늘의 마무리

앱을 다운받고 토큰이 없는 상황에서도 처음부터 소켓을 열 수 있는 방법을 찾았다. 앱을 시작할 때 토큰이 있는지 확인한 후 없으면 일단 토큰부터 받아오고 연결을 한다. 토큰을 저장하면서 처음시작하는 것이라는 걸 알 수 있도록 firstTime 이라는 이름으로 로컬 스토리지에 스트링을 저장한다. 그리고 고양이 선택 페이지로 넘긴뒤 고양이를 선택하면 그때 고양이 정보를 서버에 넘겨서 업데이트하고 firstTime 을 로컬에서 지운다. 그러면 언제든지 소켓을 처음부터 연결할 수 있고 context API 를 통해 전역에서 소켓을 관리할 수 있다. 지하철타고 출근하면서 생각한 방법인데 먹혀서 다행이다.

이제 채팅룸쪽도 다시 고치면서 어느정도 안정화가 되었고 타이머도 늦게 들어오는 사람들도 정확한(조금 오차는 있다) 시간을 알 수 있도록 서버에서 보내주는 남은 시간을 가지고 타이머를 리팩토링했다. 처음에 뭐가 문제였는지 엄청 꼬여가지고 계속 못하고 삽질만 하다가 잠깐 쉬면서 정리를 해보니 한줄만 고치면 되었다. 역시 너무 매몰되어 있으면 문제가 잘 보이지 않는다.
그건 그렇고 여전히 timepicker 로 프롭을 내려줄때 그냥 셋스테이트한건 왜 안내려가는지 정확히 모르겠다. 바뀐 값이 있어야만 내려가는 듯 하다.

나머지 자잘한 것들, 오류들 고치고 오늘 나름 완성도가 올라갔다.

# ( ⓛ ω ⓛ \*) meooooooow

오늘의할일 (8 월 21 일 화요일)

1. 프로필 편집화면 만들기
2. 처음부터 끝까지 hit heal 빼고 최적화화

오늘의 마무리

프로필 편집화면(고양이를 새로 선택하는 화면)은 추가했고 소소한 코드를 수정했다. 최적화는 아직 작업 못함.
뮤트하는거 같이 고민하느라 딱히 많은 작업 못함.
서버가 왜 터지는지 같이 고민했는데 가장 유력한 가설은 앱을 사용하지 않는 상태로 있으면 소켓연결이 끊기는데 그 상태로 방에 진입하면 디비에서 유저 정보를 받아오지 못한 상태로 유저아이디를 찾느라 서버가 터지는 것 같다.

# ( ⓛ ω ⓛ \*) meooooooow

오늘의할일 (8 월 22 일 수요일)

1. 프로필 편집에서 업적에 따라 새로운 고양이 선택
2. 코드 정리

오늘의 마무리

업적에 따른 고양이 선택은 테스트로 하나 넣어둠. 나중에 더 짜넣으면 될 것 같음. 플렉스 맞추고 이쁘게 넣어두는 걸 고민해야 할듯.
코드를 처음부터 보면서 필요없는 주석들을 지우고 app presenter 를 소켓과 함수를 구분지어서 순서를 바꾸어둠. 원석이와 상의해서 모듈화를 진행해야 겠음.

생각보다 큰 기능들은 추가할게 없어서 지금 구현되는 정도로 가면 붕 뜰 것 같았는데 체크인하면서 어느정도 가닥을 잡음. 다만 해빈님이 피드백 준게 처음 어플을 구상했을 때와 다르게 주변 고양이들과 이야기한다는 느낌이 없고 그냥 채팅에 가까워진것 같다는 느낌. 채팅 구현에 너무 힘쓰다보니 그런 부분을 간과하고 있었다. 채팅을 갈아엎는건 시간상 무리일것 같고 현재 프레임에서 UI 로 주변 고양이들과 만난다는 느낌을 주는 편이 나을 것 같다.

# ( ⓛ ω ⓛ \*) meooooooow

오늘의 한일 (8 월 23 일 목요일)

삽질만 존나 했다.
백그라운드됬을 때 시간이 멈춰 있어서 다시 시간을 받아와서 타이머를 돌려주는 걸 하던 중 잘 터지던 방이 안터지는 걸 발견했다. 여러명이 있을 때 안터지고 먹통이 되는 클라이언트가 계속 발생했다. 둘 다 터질 때도 있고 하나 둘 안터질때도 있고 대체 어디가 문제인지 알 수가 없었다. 그래서 하루 종일 그걸 잡으려고 이렇게 저렇게 삽질만 하다가 몇가지 가설이 나왔다.
동진님의 가설 : leaveRoom 이벤트가 발생하면 roomusers 스테이트를 바꿔주는데 바꾸고 바로 밑에서 또 resetchat 이라는 함수로 스테이를 다시 바꿔주니 꼬이는 것 같다.
나의 가설 : 동진님 가설을 검증하던 중에 리브 룸 이벤트 위에 timeOver 스테이트를 바꿔주는게 있다. 혹시 여기에서 넘어가지 않아서 리브룸으로 넘기질 못해 먹통이 되는 걸까 생각해봄.

태풍온다 집에 일찍 가자

# ( ⓛ ω ⓛ \*) meooooooow

오늘의 한일 (8 월 24 일 금요일)

1. 타이머 인덱스에서 백그라운드에 갔다가 돌아올 때 남은 시간을 받아와서 getDerivedStateFromProps 를 통해 새로 들어온 prop 을 이전 것과 비교해 다르면 state.time 을 바꿔주는 식으로 백그라운드에서 시간이 돌아가지 않는 문제를 해결했다.
   해결하는 중간에 다른 문제들이 발생했는데 nextProps.leftTime !== prevState.time 이런식으로 해놓으면 방이 폭파되었다가 다시 들어올 수도 이어서 부등호로 바꿔놓았는데 사실 문제는 그게 아니라 그 밑에 콘솔을 찍어놔서 그런게 아닐까 싶기도 했다. 지금 !== 로 바꿔서 해봤는데 되네. 콘솔때문인것 같다. 뭐냐 콘솔 너.

getDerivedStateFromProps 는 잘 쓰면 좋을 것 같다. 들어오는 props 를 state 와 비교하거나 바꿔줘야할때 좋다.

nextProps.leftTime < prevState.time <===== NEW!!! 이렇게 안하면 챗이 들어올때 마다 비교해서 시간을 다시 처음 받아온걸로 되돌린다 무조건 이걸로 해야해 ㅋㅋㅋㅋㅋ 해놓고 왜 해놨는지 까먹음ㅋㅋㅋㅋ

2. 앱이 백그라운드에 있다가 방이 폭파되어야할 시간이 지나버려서 폭파가 안되는 문제가 있었다. 그리고 1 초마다 들어오는 시간 props 를 넘겨주기 위해 componentWillRecieveProps 를 쓰고 있어서 언젠가 바꿔야지 하고 있었다. 이번에 백그라운드 문제를 해결하기 위해 componentWillRecieveProps 를 버리고 getDerivedStateFromProps 로 바꾸고 그 안에서 들어오는 props.time 과 state 에 설정해둔 timeLimit 을 비교해 timeover 라는 state 를 바꿔주고 componentDidUpdate 를 통해 랜더 후 스테이트가 변경된 시점에 stopTimer 를 실행해 방을 나가게끔 해줬다.

컴포넌트 라이프 사이클 함수가 이번에 업데이트되면서 사라지는 것들도 있고 새로 만들어진 것들을 써야하는데 익숙하지 않아서 잘 못쓰고 있었다. 그리고 라이프 사이클에 대한 좀 더 정확한 이해가 필요하다. 그래야 필요한 부분만 랜더를 하고 최적화하거나 타이머 같은 부분을 만드는데 삽질을 덜 할 수 있을 것 같다.

# ( ⓛ ω ⓛ \*) meooooooow

오늘의 한일 (8 월 25 일 토요일)

1. 타이머를 클라이언트에서 setInterval 로 초기 값에서 1 씩 빼다보니 채팅이 랜더가 많이되서 스택에 쌓이면 시간이 느리게 간다. 그러면 같은 방에 있는 클라이언트끼리 시간이 엄청나게 차이가 나버리게 된다. 그래서 처음 받아오는 시간에서 매번 현재 시간을 빼서 최대한 정확한 남은 시간을 뿌려준다. 최대 1 초정도 차이가 나는 듯 하다. 대신 채팅으로 시간차이나 났더라도 다시 보정이 가능하다.

애매하게 0 초에 들어오면 0 부터 시작해서 마이너스로 가는 정신과시간의 방이 생기는걸 해결했다. 서버에서 10 초 남으면 방에 못들어오게 막아버림. ㅋㅋㅋㅋㅋ
